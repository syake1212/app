<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resilience App - 防災統合ツール</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome for specific icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            overscroll-behavior: none;
        }

        /* 緊急モード時の激しい点滅アニメーション */
        @keyframes pulse-alert {
            0%, 100% { background-color: #ef4444; color: white; }
            50% { background-color: #000; color: #ef4444; }
        }
        .animate-alert {
            animation: pulse-alert 1s infinite;
        }

        /* ホイッスルボタンのアニメーション */
        @keyframes ping-slow {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .animate-ping-slow {
            animation: ping-slow 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Mock Data & Constants ---
        
        // 疑似避難所データ
        const SHELTERS = [
            { id: 1, name: "市民体育館", lat: 35.6895, lng: 139.6917, dist: 350, bearing: 45 },
            { id: 2, name: "第三小学校", lat: 35.6890, lng: 139.7000, dist: 800, bearing: 180 },
        ];

        // --- Components ---

        // 1. SOS Button (Whistle & Share)
        const SOSPanel = ({ isEmergency, onSOS }) => {
            const [isPlaying, setIsPlaying] = useState(false);
            const audioCtxRef = useRef(null);
            const oscillatorRef = useRef(null);

            const toggleWhistle = () => {
                if (isPlaying) {
                    stopWhistle();
                } else {
                    startWhistle();
                }
            };

            const startWhistle = () => {
                if (!audioCtxRef.current) {
                    audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                const ctx = audioCtxRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                // 3000Hz - 4000Hzの高周波（人間の耳に届きやすい）
                osc.type = 'square';
                osc.frequency.setValueAtTime(3000, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(4000, ctx.currentTime + 0.1);
                
                // 変調をかけてより気づきやすくする
                const lfo = ctx.createOscillator();
                lfo.type = 'sawtooth';
                lfo.frequency.value = 5; // 5Hzで断続
                const lfoGain = ctx.createGain();
                lfoGain.gain.value = 500;
                
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                lfo.start();

                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();

                oscillatorRef.current = { osc, lfo, gain };
                setIsPlaying(true);
            };

            const stopWhistle = () => {
                if (oscillatorRef.current) {
                    oscillatorRef.current.osc.stop();
                    oscillatorRef.current.lfo.stop();
                    oscillatorRef.current.osc.disconnect();
                }
                setIsPlaying(false);
            };

            const shareLocation = () => {
                const text = "【緊急】助けてください。私はここにいます。";
                const url = "https://www.google.com/maps?q=35.6895,139.6917"; // Mock Location
                
                if (navigator.share) {
                    navigator.share({ title: '緊急SOS', text: text, url: url });
                } else {
                    alert(`以下の内容をコピーしました:\n${text}\n${url}`);
                    // Copy simulation
                }
            };

            return (
                <div className="grid grid-cols-2 gap-4 mt-4">
                    <button 
                        onClick={toggleWhistle}
                        className={`p-6 rounded-2xl flex flex-col items-center justify-center shadow-lg transition-all active:scale-95 ${
                            isPlaying 
                            ? 'bg-red-600 text-white animate-pulse' 
                            : 'bg-white border-4 border-red-600 text-red-600'
                        }`}
                    >
                        <i className={`fas fa-bullhorn text-4xl mb-2 ${isPlaying ? 'animate-bounce' : ''}`}></i>
                        <span className="font-bold text-lg">ホイッスル</span>
                        <span className="text-xs">{isPlaying ? '吹鳴中' : 'タップで鳴らす'}</span>
                    </button>

                    <button 
                        onClick={shareLocation}
                        className="bg-black text-yellow-400 p-6 rounded-2xl flex flex-col items-center justify-center shadow-lg active:scale-95"
                    >
                        <i className="fas fa-paper-plane text-4xl mb-2"></i>
                        <span className="font-bold text-lg">位置送信</span>
                        <span className="text-xs">LINE/SMS連携</span>
                    </button>
                </div>
            );
        };

        // 2. Seismometer (Accelerometer Visualizer)
        const Seismometer = ({ intensity, setIntensity }) => {
            // intensity: 0.0 to 10.0 (simulate Gal/Shindo)
            
            // 震度階級の判定 (簡易ロジック)
            const shindo = useMemo(() => {
                if (intensity < 1) return "0";
                if (intensity < 3) return "1";
                if (intensity < 5) return "2";
                if (intensity < 8) return "3";
                if (intensity < 15) return "4";
                if (intensity < 30) return "5弱";
                if (intensity < 50) return "5強";
                if (intensity < 80) return "6弱";
                return "6強"; // Simplified max
            }, [intensity]);

            const colorClass = useMemo(() => {
                if (intensity < 15) return "bg-blue-50 text-blue-900"; // Safe
                if (intensity < 30) return "bg-yellow-50 text-yellow-900 border-yellow-400"; // Caution
                return "bg-red-600 text-white animate-alert"; // Danger
            }, [intensity]);

            return (
                <div className={`p-4 rounded-xl shadow-sm border transition-colors duration-300 ${colorClass}`}>
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="font-bold flex items-center gap-2">
                            <i className="fas fa-wave-square"></i> リアルタイム震度推定
                        </h3>
                        <span className="text-xs opacity-80">独自のアルゴリズム</span>
                    </div>
                    <div className="flex items-end gap-4">
                        <div className="text-5xl font-black">{shindo}</div>
                        <div className="mb-2 text-sm font-bold opacity-80">
                            推定<br/>震度
                        </div>
                        <div className="flex-1 h-12 flex items-end gap-1 pb-1">
                             {/* Fake visualizer bars */}
                             {[...Array(10)].map((_, i) => (
                                 <div 
                                    key={i} 
                                    className={`w-full transition-all duration-100 ${intensity > 30 ? 'bg-white' : 'bg-current'}`}
                                    style={{ 
                                        height: `${Math.min(100, Math.random() * intensity * 2)}%`,
                                        opacity: 0.5 + (i/20)
                                    }} 
                                 />
                             ))}
                        </div>
                    </div>
                    
                    {/* Simulator Controls */}
                    <div className="mt-4 pt-2 border-t border-current border-opacity-20">
                        <label className="text-xs font-bold block mb-1 opacity-70">
                            [デバッグ用] 揺れシミュレーター (スライダーを動かす)
                        </label>
                        <input 
                            type="range" 
                            min="0" 
                            max="100" 
                            value={intensity} 
                            onChange={(e) => setIntensity(parseInt(e.target.value))}
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        />
                    </div>
                </div>
            );
        };

        // 3. River Monitor (Water Level & Risk Logic)
        const RiverMonitor = ({ isQuakeWarning }) => {
            // Mock River Data
            const [level, setLevel] = useState(2.1);
            const DANGER_LEVEL = 4.0;
            const WARNING_LEVEL = 2.5;

            // 複合リスク判定ロジックの実装
            // 地震発生後(isQuakeWarning=true)は、基準値を厳しくする
            const riskStatus = useMemo(() => {
                const thresholdModifier = isQuakeWarning ? 0.8 : 1.0;
                
                if (level >= DANGER_LEVEL * thresholdModifier) return { text: "氾濫危険", color: "bg-purple-600 text-white", icon: "fa-skull-crossbones" };
                if (level >= WARNING_LEVEL * thresholdModifier) return { text: "避難判断", color: "bg-red-500 text-white", icon: "fa-person-running" };
                if (level >= 1.5) return { text: "氾濫注意", color: "bg-yellow-400 text-black", icon: "fa-exclamation-triangle" };
                return { text: "平常", color: "bg-blue-100 text-blue-800", icon: "fa-water" };
            }, [level, isQuakeWarning]);

            return (
                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mt-4">
                     <div className="flex justify-between items-center mb-3">
                        <h3 className="font-bold text-gray-700 flex items-center gap-2">
                            <i className="fas fa-water text-blue-500"></i> ○○川 水位情報
                        </h3>
                        <div className={`px-2 py-1 rounded text-xs font-bold ${isQuakeWarning ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                            {isQuakeWarning ? "⚠ 地震により地盤緩み" : "地盤: 安定"}
                        </div>
                    </div>

                    <div className="flex items-center gap-4">
                        <div className={`flex-1 p-3 rounded-lg flex items-center justify-center gap-2 font-bold ${riskStatus.color}`}>
                            <i className={`fas ${riskStatus.icon}`}></i>
                            {riskStatus.text}
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-bold font-mono">{level.toFixed(2)}m</div>
                            <div className="text-xs text-gray-500">危険水位: {DANGER_LEVEL}m</div>
                        </div>
                    </div>

                    {/* Simulator */}
                    <input 
                        type="range" 
                        min="0" 
                        max="6" 
                        step="0.1"
                        value={level} 
                        onChange={(e) => setLevel(parseFloat(e.target.value))}
                        className="w-full mt-3 h-1 bg-blue-100 rounded-lg appearance-none cursor-pointer"
                    />
                </div>
            );
        };

        // 4. Compass AR (Simple Implementation)
        const CompassAR = ({ target }) => {
            const [heading, setHeading] = useState(0);

            // デバイスの向きシミュレーション
            // 実際は 'deviceorientation' イベントを使うが、PCプレビュー用にスライダー
            
            const bearingToTarget = target.bearing; 
            const arrowRotation = (bearingToTarget - heading + 360) % 360;

            return (
                <div className="relative h-64 bg-gray-900 rounded-xl overflow-hidden mt-4 shadow-inner group">
                    {/* Camera Feed Simulation (Gray background) */}
                    <div className="absolute inset-0 flex items-center justify-center opacity-20">
                        <i className="fas fa-camera text-6xl text-white"></i>
                        <p className="absolute bottom-4 text-white text-xs">AR Camera Feed</p>
                    </div>

                    {/* HUD Overlay */}
                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <div className="text-yellow-400 font-bold text-xl drop-shadow-md mb-2">
                            {target.name}
                        </div>
                        <div className="text-white text-sm mb-4 drop-shadow-md">
                            あと <span className="text-2xl font-bold">{target.dist}</span> m
                        </div>
                        
                        {/* The Compass Arrow */}
                        <div 
                            className="transition-transform duration-300 ease-out drop-shadow-lg"
                            style={{ transform: `rotate(${arrowRotation}deg)` }}
                        >
                            <i className="fas fa-location-arrow text-6xl text-green-400"></i>
                        </div>
                    </div>

                    {/* Simulator Control Overlay (Hover to show) */}
                    <div className="absolute bottom-0 left-0 right-0 p-2 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity">
                        <label className="text-white text-xs">Simulate Rotation</label>
                        <input 
                            type="range" max="360" 
                            value={heading}
                            onChange={(e) => setHeading(parseInt(e.target.value))}
                            className="w-full"
                        />
                    </div>
                </div>
            );
        };

        // --- Main App Container ---
        const App = () => {
            // Mode: 'normal' | 'emergency'
            const [mode, setMode] = useState('normal');
            
            // Shared State
            const [quakeIntensity, setQuakeIntensity] = useState(0); // 0-100

            // Auto-switch to emergency if quake is strong
            useEffect(() => {
                if (quakeIntensity > 50 && mode === 'normal') {
                    setMode('emergency');
                }
            }, [quakeIntensity]);

            const isEmergency = mode === 'emergency';

            return (
                <div className={`min-h-screen pb-10 transition-colors duration-500 ${isEmergency ? 'bg-gray-900' : 'bg-slate-50'}`}>
                    {/* Header */}
                    <header className={`p-4 sticky top-0 z-50 shadow-md flex justify-between items-center ${isEmergency ? 'bg-black text-yellow-400 border-b-4 border-yellow-400' : 'bg-white text-slate-800'}`}>
                        <div className="flex items-center gap-2">
                            <i className="fas fa-shield-alt text-2xl"></i>
                            <h1 className="font-black text-xl tracking-tighter">RESILIENCE</h1>
                        </div>
                        <button 
                            onClick={() => setMode(isEmergency ? 'normal' : 'emergency')}
                            className={`px-4 py-2 rounded-full font-bold text-sm transition-all ${
                                isEmergency 
                                ? 'bg-yellow-400 text-black shadow-[0_0_15px_rgba(250,204,21,0.6)]' 
                                : 'bg-slate-200 text-slate-600'
                            }`}
                        >
                            {isEmergency ? '緊急モード中' : '平時モード'}
                        </button>
                    </header>

                    {/* Main Content */}
                    <main className="p-4 max-w-md mx-auto">
                        
                        {/* 1. Sensing Core */}
                        <section className="mb-6">
                            <Seismometer 
                                intensity={quakeIntensity} 
                                setIntensity={setQuakeIntensity} 
                            />
                        </section>

                        {/* 2. Emergency Actions (Priority in Emergency Mode) */}
                        {isEmergency && (
                            <section className="mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <h2 className="text-yellow-400 font-bold text-lg mb-2 border-l-4 border-yellow-400 pl-2">
                                    緊急アクション
                                </h2>
                                <SOSPanel isEmergency={isEmergency} />
                                
                                <div className="mt-6">
                                    <h2 className="text-white font-bold mb-2">避難サポート (AR)</h2>
                                    <CompassAR target={SHELTERS[0]} />
                                </div>
                            </section>
                        )}

                        {/* 3. Information Dashboard (Weather, River) - Always visible but styled differently */}
                        <section className={`mb-6 ${isEmergency ? 'opacity-80 grayscale' : ''}`}>
                            <h2 className={`font-bold text-lg mb-2 pl-2 border-l-4 ${isEmergency ? 'text-gray-400 border-gray-600' : 'text-slate-700 border-blue-500'}`}>
                                リスク管理情報
                            </h2>
                            
                            {/* Weather Cards (Mock) */}
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                                    <div className="text-xs text-gray-500 mb-1">現在地 気圧</div>
                                    <div className="font-bold text-xl flex items-end gap-1">
                                        1013 <span className="text-xs mb-1 font-normal">hPa</span>
                                    </div>
                                    <div className="text-xs text-red-500 mt-1">↘ 急低下中 (頭痛注意)</div>
                                </div>
                                <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                                    <div className="text-xs text-gray-500 mb-1">降水量予想</div>
                                    <div className="font-bold text-xl flex items-end gap-1">
                                        25 <span className="text-xs mb-1 font-normal">mm/h</span>
                                    </div>
                                    <div className="text-xs text-blue-500 mt-1">☂ 強い雨</div>
                                </div>
                            </div>

                            <RiverMonitor isQuakeWarning={quakeIntensity > 30} />
                        </section>

                        {/* Footer (Emergency Contact) */}
                        {!isEmergency && (
                            <div className="text-center mt-10 text-gray-400 text-xs">
                                <p>防災・減災統合プラットフォーム v1.0.0</p>
                                <p>オフライン地図データ: 最終更新 2023/10/01</p>
                            </div>
                        )}
                    </main>
                    
                    {/* Floating FAB for Quick SOS in Normal Mode */}
                    {!isEmergency && (
                        <button 
                            onClick={() => setMode('emergency')}
                            className="fixed bottom-6 right-6 w-16 h-16 bg-red-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-40 active:scale-90 transition-transform"
                        >
                            <i className="fas fa-bell"></i>
                        </button>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>